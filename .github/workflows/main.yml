# ğŸš€ CI/CD Pipeline para Azure

name: CI/CD Pipeline - Gabrielly Azure

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  AZURE_RESOURCE_GROUP: 'rg-gabrielly-semijoias-prod'
  AZURE_REGION: 'Brazil South'
  ACR_NAME: 'gabriellysemijoias'
  BACKEND_APP_NAME: 'app-gabrielly-backend-prod'
  FRONTEND_APP_NAME: 'app-gabrielly-frontend-prod'
  BACKEND_IMAGE_NAME: 'gabrielly-backend'
  FRONTEND_IMAGE_NAME: 'gabrielly-frontend'

jobs:
  # ==================== TESTES BACKEND ====================
  test-backend:
    name: ğŸ§ª Testes Backend
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: gabrielly-backend/package-lock.json

      - name: ğŸ“¦ Instalar dependÃªncias (Backend)
        working-directory: ./gabrielly-backend
        run: npm ci

      - name: ğŸ§ª Executar testes
        working-directory: ./gabrielly-backend
        run: npm test
        continue-on-error: true

  # ==================== TESTES FRONTEND ====================
  test-frontend:
    name: ğŸ§ª Testes Frontend
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: gabrielly-frontend/package-lock.json

      - name: ğŸ“¦ Instalar dependÃªncias Frontend
        run: cd gabrielly-frontend && npm ci

      - name: ğŸ§ª Rodar testes Frontend
        run: cd gabrielly-frontend && npm test -- --passWithNoTests
        continue-on-error: true

  # ==================== BUILD & PUSH IMAGENS ====================
  build_and_push_images:
    name: ğŸ”¨ Build e Push Imagens
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: ğŸ—ï¸ Build e Push Backend
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:latest \
            -f ./gabrielly-backend/Dockerfile ./gabrielly-backend
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:latest

      - name: ğŸ—ï¸ Build e Push Frontend
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:latest \
            -f ./gabrielly-frontend/Dockerfile ./gabrielly-frontend
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:latest

  # ==================== DEPLOY PRODUCTION ====================
  deploy_to_production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build_and_push_images]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸš€ Deploy Backend to App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.BACKEND_APP_NAME }}
          resource-group-name: ${{ env.AZURE_RESOURCE_GROUP }}
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.BACKEND_IMAGE_NAME }}:latest

      - name: ğŸš€ Deploy Frontend to App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.FRONTEND_APP_NAME }}
          resource-group-name: ${{ env.AZURE_RESOURCE_GROUP }}
          images: ${{ env.ACR_NAME }}.azurecr.io/${{ env.FRONTEND_IMAGE_NAME }}:latest
